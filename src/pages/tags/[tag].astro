---
import PageLayout from '../../layouts/Page.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { getAllTags, getPublishedPosts, getPostsByTag } from '../../lib/blog';

export async function getStaticPaths() {
	const posts = await getPublishedPosts();
	const tags = new Set(posts.flatMap((post) => post.data.tags ?? []));
	return [...tags].map((tag) => ({
		params: { tag },
		props: { tag },
	}));
}

const posts = await getPublishedPosts();
const tags = getAllTags(posts);
const { tag } = Astro.props;
const filtered = getPostsByTag(posts, tag);
---

<PageLayout
	title={`Blog Archive â€” ${tag}`}
	description={`Posts tagged ${tag}`}
	mainStyle="width: 1080px; padding: 2em 1.5em 5em;"
>
	<h1>Blog Archive</h1>
	<ul class="tag-list">
		<li>
			<a class="tag-link" href="/blog">Show All</a>
		</li>
		{tags.map((tagItem) => (
			<li>
				<a
					class:list={['tag-link', { active: tagItem === tag }]}
					href={`/tags/${encodeURIComponent(tagItem)}`}
				>
					#{tagItem}
				</a>
			</li>
		))}
	</ul>
	<ul class="post-grid">
		{filtered.map((post) => (
			<li>
				<a href={`/blog/${post.id}/`}>
					{post.data.heroImage && (
						<img
							src={post.data.heroImage.src}
							alt={post.data.heroImage.alt ?? ''}
							loading="lazy"
							decoding="async"
						/>
					)}
					<h4 class="title">{post.data.title}</h4>
					<p class="date">
						<FormattedDate date={post.data.pubDate} />
					</p>
					<div class="meta">
						{post.data.tags.map((tagItem) => (
							<span>#{tagItem}</span>
						))}
					</div>
				</a>
			</li>
		))}
	</ul>
	<style>
		.tag-list {
			list-style: none;
			padding: 0;
			display: flex;
			flex-wrap: wrap;
			gap: 0.4em 1em;
			margin: 0.6em 0 1.5em;
			font-size: 1em;
			color: rgb(var(--gray));
		}
		.tag-list li {
			margin: 0;
			width: auto;
		}
		.tag-link {
			color: rgb(var(--gray));
			text-decoration: none;
			transition: 0.2s ease;
			font-weight: 500;
		}
		.tag-link:hover {
			color: rgb(var(--gray-dark));
		}
		.tag-link.active {
			font-weight: 700;
		}
		.post-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
			gap: 1.5rem;
			list-style-type: none;
			margin: 0;
			padding: 0;
		}
		.post-grid li {
			width: 100%;
		}
		.post-grid li * {
			text-decoration: none;
			transition: 0.2s ease;
		}
		.post-grid li img {
			margin-bottom: 0.5rem;
			border-radius: 14px;
			border: 1px solid rgba(var(--border), 0.9);
		}
		.post-grid li a {
			display: block;
			padding: 1em;
			border-radius: 16px;
			border: 1px solid rgba(var(--border), 0.9);
			background: rgba(var(--surface), 1);
			transition: 0.2s ease;
		}
		.title {
			margin: 0;
			color: rgb(var(--black));
			line-height: 1;
		}
		.date {
			margin: 0;
			color: rgb(var(--gray));
		}
		.post-grid li a:hover h4,
		.post-grid li a:hover .date {
			color: rgb(var(--accent));
		}
		.post-grid li a:hover {
			border-color: rgba(37, 99, 235, 0.3);
			box-shadow: var(--box-shadow);
		}
		.post-grid a:hover img {
			box-shadow: var(--box-shadow);
		}
		.meta {
			display: flex;
			gap: 0.5em;
			flex-wrap: wrap;
		}
		.meta span {
			font-size: 0.85em;
			color: rgb(var(--gray));
		}
		@media (max-width: 720px) {
			.post-grid {
				gap: 1em;
			}
		}
	</style>
</PageLayout>
